# Test coverage workflow - generates HTML report and deploys to GitHub Pages
# Coverage report available at: https://dereckmezquita.github.io/hpfi/coverage/
on:
  workflow_dispatch:

name: test-coverage

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-coverage:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::covr, any::DT
          needs: coverage

      - name: Generate coverage report
        run: |
          # Calculate coverage
          cov <- covr::package_coverage()

          # Get percentage for badge
          pct <- covr::percent_coverage(cov)

          # Determine badge color
          color <- if (pct >= 80) "brightgreen" else if (pct >= 60) "yellow" else "red"

          # Create output directory
          dir.create("coverage", showWarnings = FALSE)

          # Generate HTML report
          covr::report(cov, file = "coverage/index.html", browse = FALSE)

          # Create JSON for shields.io badge
          badge_json <- sprintf('{"schemaVersion":1,"label":"coverage","message":"%.1f%%","color":"%s"}', pct, color)
          writeLines(badge_json, "coverage/badge.json")

          # Print summary
          cat("\n=== Coverage Summary ===\n")
          cat(sprintf("Overall: %.2f%%\n", pct))
          print(cov)
        shell: Rscript {0}

      - name: Deploy coverage to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./coverage
          destination_dir: coverage
          keep_files: true
